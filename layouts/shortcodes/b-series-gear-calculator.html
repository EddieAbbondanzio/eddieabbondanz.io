<!-- Import vue in the calc instead of page header to avoid loading it on every page. -->
{{- if not ($.Page.Scratch.Get "vueCount") }}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>{{ end }}
{{- $.Page.Scratch.Add "vueCount" 1 -}}

<div id="b-series-gear-calculator"></div>

<script type="module">
  const TRANSMISSION_CODE = {
    S80: 's80',
    Y21: 'y21',
    S21: 's21',
    S4C: 's4c',
    Y80: 'y80',
    YS1: 'ys1',
    Y1: 'y1',
    S1: 's1',
    J1: 'j1',
  };

  const CHASSIS = {
    USDM_94_95_DELSOL: "usdm_94_95_delsol",
    USDM_95_97_DELSOL: "usdm_95_97_delsol",
    USDM_99_01_CIVIC_SI: "usdm_99_01_civic_si",
    USDM_92_93_GSR: "usdm_92_93_gsr",
    USDM_94_01_GSR: "usdm_94_01_gsr",
    USDM_90_93_INTEGRA_RS_LS_GS_SE: "usdm_90_93_integra_rs_ls_gs_se",
    USDM_94_01_LS_GS_SE: "usdm_94_01_ls_gs_se",
    USDM_97_01_ITR: "usdm_97_01_itr",
    JDM_89_91_CIVIC_CRX_SIR: "jdm_89_91_civic_crx_sir",
    JDM_90_91_INTEGRA_RSI_XSI: "jdm_90_91_integra_rsi_xsi",
    JDM_92_93_INTEGRA_RSI_XSI: "jdm_92_93_integra_rsi_xsi",
    JDM_93_5_01_SIR_SIG: "jdm_93.5_01_sir_sig",
    JDM_92_00_SIR_CTR: "jdm_92_00_sir_ctr",
    JDM_95_97_ITR: "jdm_95_97_itr",
    JDM_98_01_ITR: "jdm-98-01-itr",
  };

  const TRANSMISSION_CHASSIS_SPECS = {
    [TRANSMISSION_CODE.S80]: {
      [CHASSIS.JDM_93_5_01_SIR_SIG]: {
        gears: [3.23, 1.9, 1.36, 1.034, 0.787],
        finalDrive: 4.4,
        clutchType: 'hydro'
      },
      [CHASSIS.JDM_95_97_ITR]: {
        gears: [3.23, 2.105, 1.458, 1.107, 0.848],
        finalDrive: 4.4,
        clutchType: 'hydro'
      },
      [CHASSIS.JDM_98_01_ITR]: {
        gears: [3.23, 2.105, 1.458, 1.034, 0.787],
        finalDrive: 4.785,
        clutchType: 'hydro'
      },
      [CHASSIS.USDM_94_01_LS_GS_SE]: {
        gear: [3.23, 1.9, 1.269, 0.966, .787],
        finalDrive: 4.266,
        clutchType: 'hydro'
      },
      [CHASSIS.USDM_94_01_GSR]: {
        gears: [3.23, 1.9, 1.36, 1.034, 0.787],
        finalDrive: 4.4,
        clutchType: 'hydro'
      },
      [CHASSIS.USDM_97_01_ITR]: {
        gears: [3.23, 2.105, 1.458, 1.107, 0.848],
        finalDrive: 4.4,
        clutchType: 'hydro'
      }
    },
    [TRANSMISSION_CODE.Y21]: {
      [CHASSIS.USDM_94_95_DELSOL]: {
        gear: [3.23, 2.105, 1.458, 1.107, 0.848],
        finalDrive: 4.4,
        clutchType: 'hydro'
      },
    },
    [TRANSMISSION_CODE.S21]: {
      [CHASSIS.USDM_95_97_DELSOL]: {
        gear: [3.23, 2.105, 1.458, 1.107, 0.848],
        finalDrive: 4.4,
        clutchType: 'hydro'
      },
    },
    [TRANSMISSION_CODE.S4C]: {
      [CHASSIS.USDM_99_01_CIVIC_SI]: {
        gear: [3.23, 2.105, 1.458, 1.107, 0.875],
        finalDrive: 4.266,
        clutchType: 'hydro'
      }
    },
    [TRANSMISSION_CODE.Y80]: {
      [CHASSIS.JDM_93_5_01_SIR_SIG]: {
        gears: [3.23, 1.9, 1.36, 1.034, 0.787],
        finalDrive: 4.4,
        clutchType: 'hydro'
      },
      [CHASSIS.JDM_95_97_ITR]: {
        gears: [3.23, 2.105, 1.458, 1.107, 0.848],
        finalDrive: 4.4,
        clutchType: 'hydro'
      },
      [CHASSIS.JDM_92_00_SIR_CTR]: {
        gears: [3.23, 2.105, 1.458, 1.107, 0.848],
        finalDrive: 4.4,
        clutchType: 'hydro'
      },
      [CHASSIS.USDM_94_01_GSR]: {
        gears: [3.23, 1.9, 1.36, 1.034, 0.787],
        finalDrive: 4.4,
        clutchType: 'hydro'
      },
      [CHASSIS.USDM_97_01_ITR]: {
        gears: [3.23, 2.105, 1.458, 1.107, 0.848],
        finalDrive: 4.4,
        clutchType: 'hydro'
      }
    },
    [TRANSMISSION_CODE.YS1]: {
      [CHASSIS.JDM_92_93_INTEGRA_RSI_XSI]: {
        gears: [3.307, 2.105, 1.459, 1.107, 0.875],
        finalDrive: 4.4,
        clutchType: 'cable'
      },
      [CHASSIS.USDM_92_93_GSR]: {
        gears: [3.307, 2.105, 1.459, 1.107, 0.875],
        finalDrive: 4.4,
        clutchType: 'cable'
      },
      [CHASSIS.USDM_90_93_INTEGRA_RS_LS_GS_SE]: {
        gears: [3.23, 1.9, 1.269, 0.966, 0.742],
        finalDrive: 4.4,
        clutchType: 'cable'
      },
    },
    [TRANSMISSION_CODE.Y1]: {
      [CHASSIS.JDM_89_91_CIVIC_CRX_SIR]: {
        gears: [3.166, 2.052, 1.416, 1.103, 0.870],
        finalDrive: 4.266,
        clutchType: 'cable'
      }
    },
    [TRANSMISSION_CODE.S1]: {
      [CHASSIS.JDM_90_91_INTEGRA_RSI_XSI]: {
        gears: [3.230, 2.105, 1.458, 1.107, 0.848],
        finalDrive: 4.4,
        clutchType: 'cable'
      },
      [CHASSIS.USDM_90_93_INTEGRA_RS_LS_GS_SE]: {
        gears: [3.230, 1.9, 1.269, 0.966, 0.742],
        finalDrive: 4.266,
        clutchType: 'cable'
      }
    },
    [TRANSMISSION_CODE.J1]: {
      [CHASSIS.JDM_90_91_INTEGRA_RSI_XSI]: {
        gears: [3.230, 2.105, 1.458, 1.107, 0.848],
        finalDrive: 4.4,
        clutchType: 'cable'
      }
    }
  };

  const { createApp, ref, computed } = Vue;
  const app = createApp({
    delimiters: ["[[", "]]"],
    setup() {
      const availableTireWidths = [175, 185, 195, 205, 215, 225, 235, 245, 255, 265, 275]
      const availableTireRatios = [25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80]
      const availableTireDiameters = [13,14,15,16,17,18]

      const tireWidth = ref(205);
      const tireRatio = ref(50);
      const tireDiameter = ref(15);

      // Why do these break now?
      const onTireWidthChange = (v) => {
        tireWidth.value = Number(v.target.value);
      }
      const onRatioChange = (v) => tireRatio.value = Number(v.target.value);
      const onDiameterChange = (v) => tireDiameter.value = Number(v.target.value);

      const tireSizeInInches = computed(() => {
        const raw = (2 * (tireWidth.value * tireRatio.value / 100) / 25.4) + tireDiameter.value
        return `${raw.toFixed(2)}"`
      })

      return {
        availableTireWidths,
        availableTireRatios,
        availableTireDiameters,
        tireWidth,
        tireRatio,
        tireDiameter,
        tireSizeInInches,
        onTireWidthChange,
        onRatioChange,
        onDiameterChange
      }
    },
    template: `
      <!-- On large displays inputs will be on left, graph on right. -->
      <!-- On small displays inputs will be on top, graph on bottom -->
      <div class="fr">
        <div class="fc">
          <strong>Tire size <small>([[tireSizeInInches]])</small></strong>
          <div class="fr">
            <sl-select placeholder="Width" class="pr2" :value="tireWidth.toString()" @sl-change="onTireWidthChange">
              <sl-option v-for="w in availableTireWidths" :value="w">[[w]]</sl-option>
            </sl-select>

            <sl-select placeholder="Ratio" class="pr2" :value="tireRatio.toString()" @sl-change="onRatioChange">
              <sl-option v-for="r in availableTireRatios" :value="r">[[r]]</sl-option>
            </sl-select>

            <sl-select placeholder="Diameter" :value="tireDiameter.toString()" @sl-change="onDiameterChange">
              <sl-option v-for="d in availableTireDiameters" :value="d">[[d]]</sl-option>
            </sl-select>
          </div>

          <strong>Redline</strong>
          <sl-input value="7000"></sl-input>
          <sl-divider></sl-divider>

          <strong>Transmission code</strong>
          <sl-select id="transmission-code">
          </sl-select>

          <strong>Chassis</strong>
          <sl-select id="chassis"> </sl-select>

          <strong>Gears</strong>
          <div class="fr jcsb">
            <span>1st</span>
            <sl-input value="3.2"></sl-input>
          </div>

          <div class="fr jcsb">
            <span>2nd</span>
            <sl-input value="3.2"></sl-input>
          </div>

          <div class="fr jcsb">
            <span>3rd</span>
            <sl-input value="3.2"></sl-input>
          </div>

          <div class="fr jcsb">
            <span>4th</span>
            <sl-input value="3.2"></sl-input>
          </div>

          <div class="fr jcsb">
            <span>5th</span>
            <sl-input value="3.2"></sl-input>
          </div>

          <div class="fr jcsb">
            <span>Final drive</span>
            <sl-input value="3.2"></sl-input>
          </div>


          <sl-divider></sl-divider>
        </div>
      </div>
    `
  });

  // Tell Vue about Shoelace web comps.
  app.config.compilerOptions.isCustomElement = (tag) => tag.startsWith("sl-")
  app.mount('#b-series-gear-calculator');

  // let transCode;

  // function init() {
  //   const MIN_TIRE_WIDTH = 175;
  //   const MAX_TIRE_WIDTH = 275;
  //   const tireWidthDropdown = document.getElementById("tire-width");
  //   for (let width = MIN_TIRE_WIDTH; width <= MAX_TIRE_WIDTH; width += 10) {
  //     let option = document.createElement("sl-option");
  //     option.value = width.toString();
  //     option.innerText = width;
  //     tireWidthDropdown.appendChild(option);

  //   }

  //   setTimeout(() => {
  //     tireWidthDropdown.value = MIN_TIRE_WIDTH.toString()
  //   }, 250)

  //   const MIN_TIRE_RATIO = 20;
  //   const MAX_TIRE_RATIO = 85;
  //   const tireRatioDropdown = document.getElementById("tire-ratio");
  //   for (let ratio = MIN_TIRE_RATIO; ratio <= MAX_TIRE_RATIO; ratio += 5) {
  //     let option = document.createElement("sl-option");
  //     option.value = ratio;
  //     option.innerText = ratio;
  //     tireRatioDropdown.appendChild(option);

  //     // Default it to first value
  //     tireRatioDropdown.value ??= ratio.toString();
  //   }

  //   const MIN_TIRE_DIAMETER = 13;
  //   const MAX_TIRE_DIAMETER = 18;
  //   const tireDiameterDropdown = document.getElementById("tire-diameter");
  //   for (let diameter = MIN_TIRE_DIAMETER; diameter <= MAX_TIRE_DIAMETER; diameter += 1) {
  //     let option = document.createElement("sl-option");
  //     option.value = diameter;
  //     option.innerText = diameter;
  //     tireDiameterDropdown.appendChild(option);

  //     // Default it to first value
  //     tireDiameterDropdown.value ??= diameter;
  //   }

  //   const transmissionCodeDropdown = document.getElementById("transmission-code");
  //   for (let [label, code] of Object.entries(TRANSMISSION_CODE)) {
  //     let option = document.createElement("sl-option");
  //     option.value = code;
  //     option.innerText = label;
  //     transmissionCodeDropdown.appendChild(option);

  //     // Default it to first value
  //     transmissionCodeDropdown.value ??= code;
  //   }

  //   updateAvailableChassisOptions();

  //   // TODO:
  //   // - Populate chassis via JS depending on trans code selected
  //   // - Change gears when chassis code or trans code is changed
  //   // - Show graph of gears on side
  // }

  // function updateAvailableChassisOptions() {
  //   const transmissionCodeDropdown = document.getElementById("transmission-code");
  //   const opts = TRANSMISSION_CHASSIS_SPECS[transmissionCodeDropdown.value];
  //   console.log("AVAIL: ", opts);
  // }



  // init();
</script>